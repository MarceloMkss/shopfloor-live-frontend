<h2>Dashboard</h2>

<div class="card">
  <form [formGroup]="form" class="grid grid-3">
    <div>
      <label>De</label>
      <input type="datetime-local"
             [value]="(form.value.from | date:'yyyy-MM-ddTHH:mm')"
             (change)="form.patchValue({from: $any($event.target).value + ':00.000Z'})">
    </div>
    <div>
      <label>A</label>
      <input type="datetime-local"
             [value]="(form.value.to | date:'yyyy-MM-ddTHH:mm')"
             (change)="form.patchValue({to: $any($event.target).value + ':00.000Z'})">
    </div>
    <div style="align-self:end">
      <button type="button" (click)="form.updateValueAndValidity()">Actualizar</button>
    </div>
  </form>
</div>

<div *ngIf="data$ | async as d" class="grid grid-3">
  
  <div class="card">
    <h3>Producción por máquina</h3>

    <table *ngIf="d.productionByMachine?.length; else noProd">
      <thead><tr><th>Máquina</th><th>Qty</th></tr></thead>
      <tbody>
        <tr *ngFor="let m of d.productionByMachine">
          <td>{{ m.machine }}</td>
          <td>{{ m.qty }}</td>
        </tr>
      </tbody>
    </table>
    <ng-template #noProd><span class="muted">Sin datos en el rango.</span></ng-template>
  </div>

  <div class="card">

    <h3>Alarmas por código</h3>

    <table *ngIf="d.alarmsByCode | keyvalue as kv; else noAlarms">
      <thead><tr><th>Código</th><th>Eventos</th></tr></thead>
      <tbody>
        <tr *ngFor="let a of kv">
          <td>{{ a.key }}</td>
          <td>{{ a.value }}</td>
        </tr>
      </tbody>
    </table>
    <ng-template #noAlarms>
      <span class="muted">Sin alarmas.</span>
    </ng-template>
  </div>

  <div class="card">
    <h3>Temp. media</h3>
     <div class="kpi-big">
      {{ d.avgTemperature | number:'1.0-2' }} °C
    </div>
  </div>
</div>
